# Build a Docker image from OpenTOPAS + TOPAS-nBio and push to Docker Hub.
# Runs on push of a tag matching "v*" (e.g. v1.0) or manually (default tag: latest).
#
# Required GitHub Secrets (Settings → Secrets and variables → Actions):
#   DOCKERHUB_USERNAME  - Docker Hub username (must have push access to opentopas)
#   DOCKERHUB_TOKEN     - Docker Hub Personal Access Token
#
name: Build and push to Docker Hub

on:
  push:
    tags: [ 'v*' ]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag for the image (defaults to "latest")'
        required: false
        default: 'latest'

env:
  OPENTOPAS_IMAGE: opentopas/opentopas:latest
  DOCKERHUB_IMAGE: tmasilela/topas-nbio

jobs:
  build-and-push:
    name: Build image and push to Docker Hub
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TAG: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.tag || 'latest') || github.ref_name }}

    steps:
      - name: Checkout TOPAS-nBio
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull OpenTOPAS base image
        run: docker pull ${{ env.OPENTOPAS_IMAGE }}

      - name: Build image with TOPAS-nBio extension
        run: |
          docker build \
            -f .github/workflows/Dockerfile.ecr \
            -t ${{ env.DOCKERHUB_IMAGE }}:${{ env.TAG }} \
            .

      - name: Push image to Docker Hub
        run: |
          docker push ${{ env.DOCKERHUB_IMAGE }}:${{ env.TAG }}
          if [[ "${{ env.TAG }}" != "latest" ]]; then
            docker tag ${{ env.DOCKERHUB_IMAGE }}:${{ env.TAG }} ${{ env.DOCKERHUB_IMAGE }}:latest
            docker push ${{ env.DOCKERHUB_IMAGE }}:latest
          fi
